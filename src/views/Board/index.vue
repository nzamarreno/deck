<template>
  <div class="board outside">
    <div class="board-help" v-if="userNameToHelp">
        <p class="board-help__desc">
            A user seems to want your help!
        </p>
        <h6 class="board-help__username">
            {{userNameToHelp}}
        </h6>
    </div>
    <template v-if="hasError">
      <toaster></toaster>
    </template>
    <div class="board-error" v-if="hasError">
      <h2 class="board-error__title">Oups!</h2>
      <p
        class="board-error__desc"
      >It seems that your room is not available... You will redirect in the good place...</p>
    </div>
    <div v-if="collection" class="board__wrapper">
      <div class="board__play">
        <div class="board-play-synopsis" :style="{color: collection.color}">
          <div class="board-play-synopsis__desc">
            <h4 class="board-play-synopsis__title">{{collection.name}}</h4>

            <div class="board-play-synopsis__info">
              <ul class="board-play-folio">
                <li>{{indexGame + 1}}</li>
                <li>{{collection.cards.length}}</li>
              </ul>
              <p>{{members}} person(s)</p>
            </div>
          </div>

          <svg
            class="board-play-synopsis__shape currentColor"
            viewBox="0 0 265 273"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M263.83 153.949C265.733 184.409 262.878 231.764 233.37 250.979C220.758 259.189 204.993 262.283 190.834 266.744C172.57 272.515 157.459 274.776 139.196 267.577C121.289 260.498 104.869 250.622 85.951 246.101C72.3871 242.829 56.146 242.591 44.4262 234.084C32.5279 225.398 29.7319 209.811 25.746 196.545C20.2133 178.162 11.5276 160.91 5.04301 142.943C-2.15542 122.954 0.0457527 105.702 5.69742 85.7127C9.92129 70.8399 13.5503 55.1343 24.5561 43.593C35.9189 31.6947 52.16 26.6975 67.3898 21.7597C87.3193 15.3346 107.189 7.5413 127.535 3.13895C164.658 -4.95185 206.659 9.32603 230.039 40.083C240.331 53.647 245.09 69.7691 249.909 85.8912C256.691 108.438 262.342 130.748 263.83 153.949Z"
            />
          </svg>
        </div>

        <div class="board-card">
          <div class="board-card__wrapper" :style="{backgroundColor: collection.color}">
            <h2 class="board-card__title">{{collection.cards[indexGame].name}}</h2>
            <div
              class="board-card__picture"
              :style="{backgroundImage: `url('${collection.cards[indexGame].picture}')`}"
            ></div>
            <p class="board-card__desc">
              <strong>Definition:</strong>
              {{collection.cards[indexGame].description}}
            </p>
          </div>
        </div>
      </div>

      <div class="board__deck">
        <div class="board-room">
          <p class="board-room__share">Share your room</p>
          <div class="board-room__copy">#{{id}}</div>
        </div>
        <div class="board-deck-wrapper">
          <div class="deck-notice">
            <div class="deck-notice__title">
              Draw
              <br />a card
            </div>
            <svg
              width="106"
              height="106"
              viewBox="0 0 106 106"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <g clip-path="url(#clip0)">
                <path
                  d="M105.828 65.3934C105.717 65.1241 105.553 64.8794 105.347 64.6736L78.8477 38.1746C77.9705 37.3273 76.5725 37.3517 75.7251 38.2289C74.8985 39.0847 74.8985 40.4413 75.7251 41.2972L98.4569 64.0289H55.2062C27.1689 63.9971 4.4481 41.2763 4.41643 13.2391C4.41643 12.0196 3.42768 11.0308 2.20811 11.0308C0.988536 11.0308 0 12.0196 0 13.2391C0.0341588 43.7146 24.7308 68.4112 55.2062 68.4454H98.4569L75.7297 91.1726C74.8525 92.0199 74.8283 93.418 75.6757 94.2951C76.523 95.1723 77.921 95.1965 78.7982 94.3491C78.8166 94.3313 78.8346 94.3133 78.8522 94.2951L105.351 67.7961C105.984 67.1651 106.174 66.2149 105.833 65.3891L105.828 65.3934Z"
                  fill="#2196F3"
                />
                <path
                  d="M77.2884 94.9443C76.0689 94.9466 75.0785 93.9595 75.0762 92.74C75.0751 92.152 75.3087 91.5879 75.725 91.1726L100.665 66.2371L75.725 41.3015C74.8776 40.4244 74.9021 39.0263 75.7792 38.179C76.6351 37.3524 77.9917 37.3524 78.8475 38.179L105.346 64.678C106.209 65.5402 106.209 66.938 105.346 67.8005L78.8475 94.2995C78.4337 94.7123 77.8731 94.9441 77.2884 94.9443Z"
                  fill="white"
                />
                <path
                  d="M103.788 68.4454H55.2062C24.7308 68.4112 0.0341588 43.7146 0 13.2391C0 12.0195 0.988743 11.0308 2.20832 11.0308C3.42789 11.0308 4.41663 12.0195 4.41663 13.2391C4.44831 41.2763 27.1691 63.9973 55.2062 64.0287H103.788C105.007 64.0287 105.996 65.0175 105.996 66.237C105.996 67.4566 105.007 68.4454 103.788 68.4454Z"
                  fill="white"
                />
              </g>
              <defs>
                <clipPath id="clip0">
                  <rect width="106" height="106" fill="white" />
                </clipPath>
              </defs>
            </svg>
          </div>
          <div class="deck-command">
            <button class="deck-command__button deck-command__button--retry" @click="onReset">
                <svg class="deck-comment__icon" xmlns="http://www.w3.org/2000/svg" id="Solid" viewBox="0 0 512 512" width="512" height="512"><path d="M479.492,318.447a233.557,233.557,0,0,1-82.025,121.445A232.008,232.008,0,0,1,24,256,231.861,231.861,0,0,1,421.839,93.807l-2.976,53.576-18.549-5.456a184.564,184.564,0,0,0-32.139-31.792A182.241,182.241,0,0,0,256,72C154.542,72,72,154.542,72,256s82.542,184,184,184a182.236,182.236,0,0,0,112.174-38.135,185.25,185.25,0,0,0,65.083-96.312,24,24,0,1,1,46.235,12.894Zm-9.652-98.84a24,24,0,0,0,10.123-18.276l8-144a24,24,0,1,0-47.924-2.662l-6.32,113.761L326.777,136.976a24,24,0,1,0-13.543,46.048l136,40a23.991,23.991,0,0,0,20.611-3.417Z"/></svg>
            </button>
            <button class="deck-command__button deck-command__button--hand" @click="onHelp">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 512 512"
                width="512"
                height="512"
                class="deck-comment__icon"
              >
                <g id="Out_line" data-name="Out line">
                  <path
                    d="M370.76587,135.45239a42.00475,42.00475,0,0,0-5.10913-53.10913l-8-8a42.00419,42.00419,0,0,0-53.10938-5.10937L257.65674,22.34326a24.9704,24.9704,0,0,0-35.31348,35.31348l1.95166,1.95166,2.61621,28.77978a112.42845,112.42845,0,0,1-27.11743,84.092l-2.137-2.137a8,8,0,0,0-11.31348,0l-72,72a7.99915,7.99915,0,0,0,0,11.31348L116.68652,256,99.314,273.37256a32.00014,32.00014,0,0,0,0,45.25488l22.0586,22.0586a32.00014,32.00014,0,0,0,45.25488,0L184,323.31348l2.34326,2.34326a7.99945,7.99945,0,0,0,11.31348,0L200,323.31348,204.68652,328l-7.02978,7.02979A46.32162,46.32162,0,0,0,184,368a30.427,30.427,0,0,1-8.97021,21.65674L152,412.68652l-10.34326-10.34326a8,8,0,0,0-11.31348,0l-80,80,11.31348,11.31348L136,419.31348l74.34326,74.34326,11.31348-11.31348L163.31348,424,176,411.31348l74.34326,74.34326a7.99945,7.99945,0,0,0,11.31348,0l4.68652-4.68653A30.427,30.427,0,0,1,288,472a46.32162,46.32162,0,0,0,32.97021-13.65674L380.686,398.62744a32.03584,32.03584,0,0,0,0-45.25488l-70.0586-70.0586a32.035,32.035,0,0,0-45.25488,0L256,292.68652,243.31348,280l26.34326-26.34326a7.99915,7.99915,0,0,0,0-11.31348l-2.137-2.137a112.44861,112.44861,0,0,1,84.092-27.11743l28.77978,2.61621,1.95166,1.95166a24.9704,24.9704,0,0,0,35.31348-35.31348ZM346.34326,85.65674l8,8a25.98373,25.98373,0,0,1,4.76,30.13305L316.21021,80.89673A25.98362,25.98362,0,0,1,346.34326,85.65674ZM155.314,329.37256a16.01631,16.01631,0,0,1-19.67993,2.30688l14.02271-14.0227-11.31348-11.31348L124,320.68652l-5.657-5.657,13.3728-13.3728-11.31348-11.31348-12.77612,12.77612a16.01838,16.01838,0,0,1,3.00122-18.43334L128,267.31348,172.68652,312Zm142.97986-35.66687a16.015,16.015,0,0,1-.92126,21.60827l-7.0293,7.0293,11.31348,11.31348,7.0293-7.0293a31.77127,31.77127,0,0,0,8.25708-14.37085l4.42944,4.42945a16.019,16.019,0,0,1,0,22.62792l-7.0293,7.0293,11.31348,11.31348,7.0293-7.0293a31.80106,31.80106,0,0,0,8.27661-14.35132l4.40991,4.40992a16.019,16.019,0,0,1,0,22.62792l-7.0293,7.0293,11.31348,11.31348,7.0293-7.0293a31.80106,31.80106,0,0,0,8.27661-14.35132l4.40991,4.40992a16.019,16.019,0,0,1,0,22.62792l-59.71582,59.71583A30.427,30.427,0,0,1,288,456a46.30157,46.30157,0,0,0-31.98633,12.7002L187.2998,399.98633a47.08639,47.08639,0,0,0,4.22-5.15308l18.82348,18.82349,11.31348-11.31348-23.03613-23.03613A46.93158,46.93158,0,0,0,200,368a30.427,30.427,0,0,1,8.97021-21.65674L216,339.31348l2.34326,2.34326a30.62529,30.62529,0,0,0,48.21594-36.90247L276.686,294.62744A16.01493,16.01493,0,0,1,298.29382,293.70569Zm-47.95056,15.95105a14.62758,14.62758,0,0,1-20.68652,20.68652L211.31348,312,232,291.31348ZM192,308.68652,131.31348,248,192,187.31348,252.68652,248ZM353.06006,197.1543a128.39526,128.39526,0,0,0-96.87988,31.7124L211.1333,183.81982a128.38526,128.38526,0,0,0,31.7124-96.87988l-.87805-9.65881L362.71887,198.03235Zm53.2832,9.189a8.982,8.982,0,0,1-12.68652,0l-160-160a8.97073,8.97073,0,0,1,12.68652-12.68652l160,160A8.98111,8.98111,0,0,1,406.34326,206.34326Z"
                  />
                  <path
                    d="M104,128a24.0275,24.0275,0,0,1,24,24,8,8,0,0,0,16,0,24.0275,24.0275,0,0,1,24-24,8,8,0,0,0,0-16,24.0275,24.0275,0,0,1-24-24,8,8,0,0,0-16,0,24.0275,24.0275,0,0,1-24,24,8,8,0,0,0,0,16Zm32-16.0249A40.33857,40.33857,0,0,0,144.0249,120,40.33857,40.33857,0,0,0,136,128.0249,40.33857,40.33857,0,0,0,127.9751,120,40.33857,40.33857,0,0,0,136,111.9751Z"
                  />
                  <path
                    d="M464,88a24.0275,24.0275,0,0,1-24-24,8,8,0,0,0-16,0,24.0275,24.0275,0,0,1-24,24,8,8,0,0,0,0,16,24.0275,24.0275,0,0,1,24,24,8,8,0,0,0,16,0,24.0275,24.0275,0,0,1,24-24,8,8,0,0,0,0-16Zm-32,16.0249A40.33857,40.33857,0,0,0,423.9751,96,40.33857,40.33857,0,0,0,432,87.9751,40.33857,40.33857,0,0,0,440.0249,96,40.33857,40.33857,0,0,0,432,104.0249Z"
                  />
                  <path
                    d="M400,256a24.0275,24.0275,0,0,1-24-24,8,8,0,0,0-16,0,24.0275,24.0275,0,0,1-24,24,8,8,0,0,0,0,16,24.0275,24.0275,0,0,1,24,24,8,8,0,0,0,16,0,24.0275,24.0275,0,0,1,24-24,8,8,0,0,0,0-16Zm-32,16.0249A40.33857,40.33857,0,0,0,359.9751,264,40.33857,40.33857,0,0,0,368,255.9751,40.33857,40.33857,0,0,0,376.0249,264,40.33857,40.33857,0,0,0,368,272.0249Z"
                  />
                </g>
              </svg>
            </button>
            <button class="deck-command__button deck-command__button--next" @click="onNext">
                <svg class="deck-comment__icon" height="512" viewBox="0 0 60 45" width="512" xmlns="http://www.w3.org/2000/svg"><path id="Shape" d="m6.941 45.3c.37977825.4440101.93472573.6997463 1.519.7h14.34c.5792651-.0055476 1.1280321-.260501 1.5058653-.6996148s.5480663-1.0197748.4671347-1.5933852c-1.081-7.29 5.141-11.129 12.227-12.525 0 1.973-.023 1.909.065 2.154.125.349.079.223 4.566 4.709.744615.7450309 1.9394581.7848298 2.732.091l15.018-13.136c.3592788-.3152593.5937701-.7487667.661-1.222.939-6.572-1.09 7.628.948-6.632.0528658-.6939848-.2612301-1.3650425-.828-1.769l-19.975-14.02c-.6063835-.44716527-1.4126121-.51560769-2.0856965-.17705912s-1.0987947 1.02663264-1.1013035 1.78005912v4.74c-20.638-1.268-36 9.528-36 30.3 0 .523-.2.137 5.941 7.3zm-2.767-6.3h13.626l4.078 5h-13.418zm18.482 2.8-3.375-4.138c.057-4.2 1.136-7.136 3.311-8.951 4.462-3.738 12.793-3.131 14.408-2.971v3.4c-7.235 1.282-14.2 5.292-14.344 12.66zm20.389-5.165-3.5-3.5 19.055-13.408-.538 3.765zm-6.157-26.943c.5503693.03103764 1.0892768-.16566238 1.490248-.54393709s.6287039-.90482017.629752-1.45606291v-4.713c20.744 14.529 19.992 13.928 19.981 14.028l-19.989 14.067v-5.334c.0064556-1.0270338-.7708508-1.8897442-1.793-1.99-1.764-.175-10.824-.823-15.9 3.422-2.528 2.112-3.833 5.345-4.007 9.828h-14.276c.493-19.166 14.976-28.448 33.864-27.308z" transform="translate(-1 -1)"/></svg>
            </button>
            <button class="deck-command__button deck-command__button--share">
                <svg class="deck-comment__icon" height="512pt" viewBox="-21 0 512 512" width="512pt" xmlns="http://www.w3.org/2000/svg"><path d="m389.332031 160c-44.09375 0-80-35.882812-80-80s35.90625-80 80-80c44.097657 0 80 35.882812 80 80s-35.902343 80-80 80zm0-128c-26.453125 0-48 21.523438-48 48s21.546875 48 48 48 48-21.523438 48-48-21.546875-48-48-48zm0 0"/><path d="m389.332031 512c-44.09375 0-80-35.882812-80-80s35.90625-80 80-80c44.097657 0 80 35.882812 80 80s-35.902343 80-80 80zm0-128c-26.453125 0-48 21.523438-48 48s21.546875 48 48 48 48-21.523438 48-48-21.546875-48-48-48zm0 0"/><path d="m80 336c-44.097656 0-80-35.882812-80-80s35.902344-80 80-80 80 35.882812 80 80-35.902344 80-80 80zm0-128c-26.453125 0-48 21.523438-48 48s21.546875 48 48 48 48-21.523438 48-48-21.546875-48-48-48zm0 0"/><path d="m135.703125 240.425781c-5.570313 0-10.988281-2.902343-13.910156-8.0625-4.375-7.679687-1.707031-17.453125 5.972656-21.824219l197.953125-112.855468c7.65625-4.414063 17.449219-1.726563 21.800781 5.976562 4.375 7.679688 1.707031 17.449219-5.972656 21.824219l-197.953125 112.851563c-2.496094 1.40625-5.203125 2.089843-7.890625 2.089843zm0 0"/><path d="m333.632812 416.425781c-2.6875 0-5.398437-.683593-7.894531-2.109375l-197.953125-112.855468c-7.679687-4.371094-10.34375-14.144532-5.972656-21.824219 4.351562-7.699219 14.125-10.367188 21.804688-5.972657l197.949218 112.851563c7.679688 4.375 10.347656 14.144531 5.976563 21.824219-2.945313 5.183594-8.363281 8.085937-13.910157 8.085937zm0 0"/></svg>
            </button>
          </div>
          <ul class="deck" @click="onNext">
            <li class="deck-card">
              <div class="deck-card__wrapper" :style="{backgroundColor: collection.color}"></div>
            </li>
            <li class="deck-card">
              <div class="deck-card__wrapper" :style="{backgroundColor: collection.color}"></div>
            </li>
            <li class="deck-card">
              <div class="deck-card__wrapper" :style="{backgroundColor: collection.color}"></div>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</template>

<script>
import Vue from "vue";
import { SOCKETEVENT } from "../../core/helpers/socket-event";
import TransitionMixin from "../../mixins/TransitionMixin";
import Toaster from "../../components/Toaster";
import { toEuler } from "../../core/helpers/conversion";

export default Vue.extend({
  mixins: [TransitionMixin],

  components: {
    Toaster
  },

  data() {
    return {
      members: 1,
      indexGame: 0,
      collection: null,
      hasError: false,
      sensor: null,
      userNameToHelp: null,
    };
  },

  mounted() {
    setTimeout(() => {
      this.$VueSocket.sendMessage({
        type: SOCKETEVENT.JOIN,
        roomId: this.$route.params.id
      });
    }, 1000);

    this.$VueSocket.onMessage(message => this.onMessage(message));
    this.bindSensor();
  },

  methods: {
    onMessage(message) {
      if (message.type === "ERROR") {
        this.hasError = true;

        setTimeout(() => {
          this.$router.push("/selection");
        }, 5000);

        return;
      } else if (message.type === "HELP") {
          this.userNameToHelp = message.username || "A guest";

            setTimeout(() => {
                this.userNameToHelp = null;
            }, 2000);
          
          return;
      }

      this.members = message.members;
      this.indexGame = message.indexGame;
      this.collection = message.collection;
    },

    onNext() {
      this.$VueSocket.sendMessage({
        type: SOCKETEVENT.NEXT,
        roomId: this.$route.params.id
      });
    },

    onReset() {
      this.$VueSocket.sendMessage({
        type: SOCKETEVENT.RESET,
        roomId: this.$route.params.id
      });
    },

    onHelp() {
      this.$VueSocket.sendMessage({
        type: SOCKETEVENT.HELP,
        roomId: this.$route.params.id
      });
    },

    handleSensor(e) {
      let quaternion = e.target.quaternion;
      let angles = toEuler(quaternion);

      if (angles[0] < 0) {
        console.log("turn Left");
      } else {
        this.onNext();
      }

      if (angles[1] < 0) {
        console.log("turn bottom");
      } else {
        console.log("turn top");
      }
    },

    bindSensor() {
      this.sensor = new AbsoluteOrientationSensor({ frequency: 60 });
      this.sensor.addEventListener("reading", e => this.handleSensor(e));
      this.sensor.start();
    },

    unBindSensor() {
      if (this.sensor)
        this.sensor.removeEventListener("reading", this.handleSensor);
    }
  },

  computed: {
    id() {
      return this.$route.params.id;
    }
  },

  detroy() {
    this.unBindSensor();
  }
});
</script>